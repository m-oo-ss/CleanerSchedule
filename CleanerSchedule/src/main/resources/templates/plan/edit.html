<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="UTF-8">

<link rel="stylesheet" th:href="@{/static/home.css}">

<title>社員トップ画面</title>
​
</head>
<body>
<div th:fragment="edit_contents">

<button id="prev" type="button">前の月</button>
<button id="next" type="button">次の月</button>
<form method="post" th:action="@{/plan/mtop}" th:object="${selectForm}" >
<div id="calendar"></div>


<button type="submit" name="update">編集確定</button>


<script th:inline="javascript" charset="utf-8">



/*<![CDATA[*/

	let planList = /*[[ ${planList} ]]*/
	let billList = /*[[ ${billList} ]]*/
	let staffList = /*[[ ${staffList} ]]*/

var week = ['日', '月', '火', '水', '木', '金', '土']
var date = new Date()
var year = date.getFullYear()
var month = date.getMonth() + 1
const config = {
    show: 1,
}


function showCalendar(year, month) {
    for ( i = 0; i < config.show; i++) {
        const Html = createCalendar(year, month)
        const sec = document.createElement('section')
        sec.innerHTML = Html
        document.querySelector('#calendar').appendChild(sec)

        month++
        if (month > 12) {
            year++
            month = 1
        }
    }

}

function createCalendar(year, month) {

    var startDate = new Date(year, month - 1, 1) // 月の最初の日を取得
    var endDate = new Date(year, month,  0) // 月の最後の日を取得
    var endDayCount = endDate.getDate() // 月の末日
    var lastMonthEndDate = new Date(year, month - 2, 0) // 前月の最後の日の情報
    var lastMonthendDayCount = lastMonthEndDate.getDate() // 前月の末日
    var startDay = startDate.getDay() // 月の最初の日の曜日を取得

    var DAY_OF_MONTH = endDate.getDate();	//今月の日数
    var DAY_OF_THE_WEEK = startDate.getDay();	//今月初日の曜日
    var dayCount = 1 // 日にちのカウント
    var Html = '' // HTMLを組み立てる変数


    Html += '<h1>' + year  + '年' + month + '月</h1>'

    + '<div class="plan" style="height:200px; width:1000px; overflow-y:scroll;">'
    + '<table class="table table-bordered table-striped text-nowrap">'


   // + '<thead>'
    Html += '<tr>'

    	//固定要素
    	//for(var i = 0; i < 3; i++){
    		Html += '<th style="position: -webkit-sticky; position: sticky; white-space: nowrap; top: 0; left: -0.1rem; background: #d98719; z-index: 6;" rowspan =2 >'
    			 + "ビル名" + '</th>'

    		Html += '<th style="position: -webkit-sticky; position: sticky; white-space: nowrap; top: 0; left: 5.7rem; background: #ff7f50; z-index: 4;" rowspan =2 >'
        		 + "人数" + '</th>'

        	Html += '<th style="position: -webkit-sticky; position: sticky; white-space: nowrap; top: 0; left: 10.1rem; background: #fffacd; z-index: 4;" rowspan =2 >'
            	 + "勤務時間" + '</th>'
    	//}

    	//曜日
    	for(var i = startDay; i < (DAY_OF_MONTH+startDay); i++){
    		Html += '<th style="position: -webkit-sticky; position: sticky; white-space: nowrap; top: 0;  background: #deb887; z-index: 3;">'
    			 + week[i%7]; +'</th>'
    	}
    	Html += '</tr>'


    	Html += '<tr>'
    	//日付
    	for(var i = 1; i <= (DAY_OF_MONTH); i++){
    		Html += '<th style="position: -webkit-sticky; position: sticky; white-space: nowrap; top: 3.5rem; background: #ff7f50; z-index: 2;">'
    			 + i +'</th>'

    	}

    	Html += '</tr>'//ここまでヘッダー部分

   // + '</thead>'
    //+ '<tbody>'

    Html += '<tr>'

    for (let bill of billList) {

		var billweek= [
			bill.billSun,
			bill.billMon,
			bill.billTue,
			bill.billWed,
			bill.billThu,
			bill.billFri,
			bill.billSat,
		]

		console.log(billweek);


	//	var start = bill.billStartTime;

	//	var h = start.getHours();
	//	var m = start.getMinutes();

	//	var select = h + "時" + m + "分;

	//  console.log(select);








    	Html += '<th style="position: -webkit-sticky; position: sticky; white-space: nowrap; left: -0.1rem; background: #d98719; z-index: 4;" rowspan ='
    	     + bill.billPeople +'>'+ bill.billName +'</th>'
		Html += '<th style="position: -webkit-sticky; position: sticky; white-space: nowrap; left: 5.7rem; background: #ff7f50; z-index: 3;" rowspan ='
		     + bill.billPeople +'>'+ bill.billPeople +'</th>'
		//slice(0,5)は〇〇：〇〇：〇〇の時刻を0 1 2 3 4 5 6 7の順番を付けて0から4まで表示させる※5まで含まれないのが注意
		Html += '<th style="position: -webkit-sticky; position: sticky; white-space: nowrap; left: 10.1rem; background: #fffacd; z-index: 2;" rowspan ='
		     + bill.billPeople +'>' + bill.billStartTime.slice(0,5) + '～' + bill.billStopTime.slice(0,5) + '</th>'





			for(var j = 1; j <= bill.billPeople; j++){

        		for (var d = 1; d <= DAY_OF_MONTH; d++) {

     			if(billweek[(d+DAY_OF_THE_WEEK-1)%7] ==0){
						Html += '<td style="background-color:#7d7d7d;"></td>'

					continue;
					}

					Html += '<td>'

         //後ろに移動       	Html += '<select id = "staffSelect">'

					//データなしの場合に分岐するためのカウント
					var count = 0
					//ループ制御のためのフラグ
					var flag = 0;
						//従業員数の分だけ繰り返す
                		for (var staff of staffList) {

							//カウントが0の時のみ実行
							if(flag == 0){
								//プランリストのデータ数の分だけ繰り返す
                				for(var plan of planList) {
                					count++

                					//日付をString型にする
                					var selectDate = new Date(startDate.getFullYear(),startDate.getMonth(),d);
                                    var yy =selectDate.getFullYear();
                                    var mm =("0"+(selectDate.getMonth()+1)).slice(-2);
                                    var dd =("0"+selectDate.getDate()).slice(-2);

                                    var selectDateStr = yy+"-"+ mm +"-"+ dd;

                					//プランリストの中から（日付＝プランの日付Idかつビルの清掃人数＝プランの清掃人数かつビルのビルId＝プランのビルIdが一致するものを表示
                					if(selectDateStr == plan.planDate
        								&& j == plan.staffNumber
        								&& bill.billId == plan.billId){
                						if(plan.restCheck == 2){

                		                	//-----表記の時だけnameに配列beanクラスのフィールド名を指定----
                							Html += '<select name ="selectForm">'
                        	 				Html += '<option selected >----'
                             					+ '</option>'
                             					count = 0;
                             					flag = 1;
                						}else{
                		                	Html += '<select name ="selectForm">'
                							Html += '<option selected value = "none,none,none,none">〇'
                             					+  plan.staffName
                             					+ '</option>'
                             					count = 0;
                             					flag = 1;
                						}

                					}//if文
                				}//プランリスト
    				            //リストを回し終わった(その日に合うプランがなかった)場合
    				            if (count >= planList.length){

    				            	Html += '<select>'
                    	 				Html += '<option selected >'
                         					+ '</option>'
                         					count = 0;
                         					flag = 1;
    			            	}
							}//プランリスト内に条件に合ったものがあればcount=1になるのでプランリスト中断

							//登録しているスタッフの名前をすべて表示

	               			Html += '<option'
                				+ ' value= '
                				+ bill.billId
                				+ ','
                				+ selectDateStr
                				+ ','
                				+ j
                				+ ','
                				+ staff.staffId
                				+ '>'
                     			+  staff.staffName
                    			+ '</option>'
                		}//スタッフ全員選択肢に格納終わり

                	Html += '</select>'
                	Html += '</td>'
        		}//月末まで終わり


        		Html += '</tr>'

			}//〇人目終わり
    }//ビル繰り返し終わり

    //Html +=  '</tbody>'
    Html += '</table>'
    	+ '</div>'



    return Html

}//createcalendar終わり

function moveCalendar(e) {
    document.getElementById('calendar').innerHTML = ''

    if (e.target.id === 'prev') {
        month--

        if (month < 1) {
            year--
            month = 12
        }
    }

    if (e.target.id === 'next') {
        month++

        if (month > 12) {
            year++
            month = 1
        }
    }

    showCalendar(year, month)
}

document.getElementById('prev').addEventListener('click', moveCalendar)
document.getElementById('next').addEventListener('click', moveCalendar)



showCalendar(year, month)


/*]]>*/
</script>


</form>

</div>

</body>
</html>