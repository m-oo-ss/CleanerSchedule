<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="UTF-8">
<title>社員トップ画面</title>​
</head>
<body>

<div th:fragment="edit_contents">

<button id="prev" type="button">前の月</button>
<button id="next" type="button">次の月</button>
<form method="post" th:action="@{/plan/mtop}" th:object="${selectForm}" >
<div id="calendar" class="table-responsive"></div>


<button type="submit" name="update">編集確定</button>


<script th:inline="javascript">



/*<![CDATA[*/

	let planList = /*[[ ${planList} ]]*/
	let billList = /*[[ ${billList} ]]*/
	let staffList = /*[[ ${staffList} ]]*/

const weeks = ['日', '月', '火', '水', '木', '金', '土']
const date = new Date()
let year = date.getFullYear()
let month = date.getMonth() + 1



function showCalendar(year, month) {

	const calendarHtml = createCalendar(year, month)
        const sec = document.createElement('section')
        sec.innerHTML = calendarHtml
        document.querySelector('#calendar').appendChild(sec)


}

function createCalendar(year, month) {

	const date = new Date();//現在

    const startDate = new Date(year, month - 1, 1) // 月の最初の日を取得
    const endDate = new Date(year, month,  0) // 月の最後の日を取得
    const endDayCount = endDate.getDate() // 月の末日
    const lastMonthEndDate = new Date(year, month-1, 0) // 前月の最後の日の情報
    const lastMonthendDayCount = lastMonthEndDate.getDate() // 前月の末日
    const startDay = startDate.getDay() // 月の最初の日の曜日を取得

    const DAY_OF_MONTH = endDate.getDate();	//今月の日数
    const DAY_OF_THE_WEEK = startDate.getDay();	//今月初日の曜日
    let dayCount = 1 // 日にちのカウント
    let Html = '' // HTMLを組み立てる変数





    Html += '<h1>' + year  + '/' + month + '</h1>'

//    + '<div style="height:500px; width:1000px; overflow-y:scroll;">'
    + '<table  class="table table-bordered table-striped text-nowrap">'

    var mm =("0"+ (month) ).slice(-2);
    var dateStr = year +"-"+ mm +"-01";
    index = planList.findIndex(x => x.planDate==dateStr);

    //表示した月の初日がプランリストになければbutton表示
    if(index == -1){
  //  	 Html += '<button type="button">先月のスケジュールを参照</button>'
    }


    Html += '<tr>'
	Html += '<th rowspan=2>ビル名</th>'
    Html += '<th rowspan=2>人数</th>'
   	Html += '<th rowspan=2>時間</th>'



    // 日付の行を作成
    for (let i = 1; i <= DAY_OF_MONTH; i++) {
      Html += '<th>' + i + '</th>'
    }

	Html +='</tr>'
    Html += '<tr>'

	//曜日
	for(var i = DAY_OF_THE_WEEK; i < (endDayCount+DAY_OF_THE_WEEK); i++){

		Html += '<th>' + weeks[i%7] + '</th>'

	}

    Html +='</tr>'

    for (let bill of billList) {

		var billweek= [
			bill.billSun,
			bill.billMon,
			bill.billTue,
			bill.billWed,
			bill.billThu,
			bill.billFri,
			bill.billSat,
		]




	//	var start = bill.billStartTime;

	//	var h = start.getHours();
	//	var m = start.getMinutes();

	//	var select = h + "時" + m + "分;

	//  console.log(select);


    	Html += '<tr>'



    	Html += '<th rowspan ='+ bill.billPeople +'>'+ bill.billName +'</th>'
		Html += '<th rowspan ='+ bill.billPeople +'>'+ bill.billPeople +'</th>'
		Html += '<th rowspan ='+ bill.billPeople +'>' + (bill.billStartTime).slice(0,5) + '～' + (bill.billStopTime).slice(0,5) + '</th>'


			for(var j = 1; j <= bill.billPeople; j++){

        		for (var d = 1; d <= DAY_OF_MONTH; d++) {

     			if(billweek[(d+DAY_OF_THE_WEEK-1)%7] ==0){
						Html += '<td style="background-color:#7d7d7d;"></td>'
					continue;
					}//曜日によって格納できるか判定

//後ろに移動					Html += '<td>'
        							Html += '<td>'
    				            	Html += '<select class='+d+' name ="selectForm" >'

    				    	    		var elements = document.getElementById("sample");
    						    	console.log(elements);
					//データなしの場合に分岐するためのカウント
					var count = 0
					//ループ制御のためのフラグ
					var flag = 0;
						//従業員数の分だけ繰り返す
                		for (var staff of staffList) {



							//フラグが0の時のみ実行
							if(flag == 0){
								//プランリストのデータ数の分だけ繰り返す
                				for(var plan of planList) {
                					count++

                					//日付をString型にする
                					var selectDate = new Date(startDate.getFullYear(),startDate.getMonth(),d);
                                    var yy =selectDate.getFullYear();
                                    var mm =("0"+(selectDate.getMonth()+1)).slice(-2);
                                    var dd =("0"+selectDate.getDate()).slice(-2);
                                    var selectDateStr = yy+"-"+ mm +"-"+ dd;



                                    if(index == -1){//表示月のプランデータがない場合、先月のプランを参照
                                        if(lastMonthendDayCount == 30){
                                            var dd2 =("0"+(d+2)).slice(-2);
                                        }else if(lastMonthendDayCount == 31){
                                        	var dd2 =("0"+(d+3)).slice(-2);
                                        }else if(lastMonthendDayCount == 29){
                                        	var dd2 =("0"+(d+1)).slice(-2);
                                        }else if(lastMonthendDayCount == 28){
                                        	var dd2 =("0"+d).slice(-2);
                                        }

                                    	var mm2 =("0"+(month-1)).slice(-2);
                                        var selectDateStr2 =  year +"-"+ mm2 +"-" + dd2;

                                      //プランリストの中から（日付＝プランの日付Idかつビルの清掃人数＝プランの清掃人数かつビルのビルId＝プランのビルIdが一致するものを表示
                    					if(selectDateStr2 == plan.planDate
            								&& j == plan.staffNumber
            								&& bill.billId == plan.billId){
                    						if(plan.restCheck == 2){
/*                    							Html += '<td style="background-color:pink;">'
                    							Html += '<select name ="selectForm">'
                            	 				Html += '<option selected >----'
                                 					+ '</option>'
                                 					count = 0;
                                 					flag = 1;*/
                                 					continue;
                    						}else{
//                   							Html += '<td>'
//                    		                	Html += '<select name ="selectForm">'
                    							Html += '<option selected value='
        	           								+ bill.billId + ',' + selectDateStr + ',' + j +',' + plan.staffId
         	          								+ ',insert >（未定）'
                                 					+  plan.staffName
                                 					+ '</option>'
                                 					count = 0;
                                 					flag = 1;
                    						}


                    					}//照らし合わせif文終わり

                                   }else{



                					//プランリストの中から（日付＝プランの日付Idかつビルの清掃人数＝プランの清掃人数かつビルのビルId＝プランのビルIdが一致するものを表示
                					if(selectDateStr == plan.planDate
        								&& j == plan.staffNumber
        								&& bill.billId == plan.billId){
                						if(plan.restCheck == 2){

//                							Html += '<td style="background-color:pink;">'




                							//-----表記の時だけnameに配列beanクラスのフィールド名を指定----
//                							Html += '<select name ="selectForm">'
                        	 				Html += '<option selected >----'
                             					+ '</option>'
                             					count = 0;
                             					flag = 1;
                						}else{

//                							Html += '<td>'
//                		                	Html += '<select name ="selectForm">'
                							Html += '<option selected value="none,none,none,none,none">〇'
                             					+  plan.staffName
                             					+ '</option>'
                             					count = 0;
                             					flag = 1;
                						}

                     					var setFlag = 0//insertかupdateか区別する
                					}//照らし合わせif文終わり
                                   }//else終わり
                				}//プランリスト
                				//リストを回し終わった(その日に合うプランがなかった)場合
    				            if (count >= planList.length){

//        							Html += '<td>'
//    				            	Html += '<select name ="selectForm">'
                    	 				Html += '<option selected value="none,none,none,none,none">'
                         					+ '</option>'
                         					count = 0;
                         					flag = 1;
                         					var setFlag = 1
    			            	}
							}//プランリスト内に条件に合ったものがあればflag=1になるのでプランリスト中断
							var dateStaff = [];
							for (plan of planList){


								 if(plan.planDate == selectDateStr){
									   dateStaff.push(plan.staffId);
								 }

							}


							//登録しているスタッフの名前をすべて表示
						  if(dateStaff.indexOf( staff.staffId ) == -1){


							Html += '<option'
                				+ ' value= '
                				+ bill.billId
                				+ ','
                				+ selectDateStr
                				+ ','
                				+ j
                				+ ','

                				+ staff.staffId + ','

                				if(setFlag == 1){
                        			Html += 'insert>'
                				}else{
                            		Html += 'update>'
                				}
                      	 	 Html +=  staff.staffName
                 			+ '</option>'

                      	   }


                		}//スタッフ全員選択肢に格納終わり

                	Html += '</select>'
                	Html += '</td>'
        		}//月末まで終わり
        		Html += '</tr>'
			}//〇人目終わり
    }//ビル繰り返し終わり

    Html += '</table>'


    return Html

}//createcalendar終わり

////////////////////////////重複
const getDuplicateValues = ([...array]) => {
  return array.filter((value, index, self) => self.indexOf(value) === index && self.lastIndexOf(value) !== index);
}

function selectCheck(){


}


function moveCalendar(e) {
    document.querySelector('#calendar').innerHTML = ''

    if (e.target.id === 'prev') {
        month--

        if (month < 1) {
            year--
            month = 12
        }
    }

    if (e.target.id === 'next') {
        month++

        if (month > 12) {
            year++
            month = 1
        }
    }
    showCalendar(year, month)
}

document.querySelector('#prev').addEventListener('click', moveCalendar)
document.querySelector('#next').addEventListener('click', moveCalendar)


showCalendar(year, month)


/*]]>*/
</script>



</form>

</div>

</body>
</html>