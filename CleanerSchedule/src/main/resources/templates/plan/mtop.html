<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
<meta charset="UTF-8">
<title>マネージャートップ：スケジュール一覧</title>
</head>
<body>
	<div th:fragment="mtop_contents">


		<button id="prev" type="button">前の月</button>
		<button id="next" type="button">次の月</button>
		<div id="calendar" class="table-responsive"></div>


		<script th:inline="javascript" charset="utf-8">
/*<![CDATA[*/
	let planList= /*[[ ${planList} ]]*/
	let billList= /*[[ ${billList} ]]*/
	let staffList= /*[[ ${staffList} ]]*/

	/////////////////////////////////////////////

	//日付関係
	var date = new Date();	//現在
	var year = date.getFullYear()	//	現在の西暦
	var month = date.getMonth() +1	//現在の月

	var week = ['日', '月', '火', '水', '木', '金', '土']
	var items = ["ビル名","人数"]


	function showCalendar(year, month) {

	        const html = createCalendar(year, month)
	        //tableタグの生成
	        const sec = document.createElement('table')
	        sec.setAttribute("class","table table-bordered table-striped text-nowrap")
	        sec.innerHTML = html
	        //id=calendarのタグを親としてsec(htmlを入れたtableタグ)を挿入
	        document.getElementById("calendar").appendChild(sec)
	}


	function createCalendar(year, month) {
		var endDate = new Date(year,month,0);	//今月末日 0は前月の末日
		var startDate = new Date(year,month-1,1);	//今月初日
		console.log(endDate,startDate);
		var DAY_OF_MONTH = endDate.getDate();	//今月の日数
		var startDay = startDate.getDay();	//今月初日の曜日


		var html = '';
		html += '<h1>' + year  + '年' + month + '月</h1>'
		html += '<tr>'
	//固定要素
	for(var i = 0; i < 2; i++){
		html += '<th rowspan =2 >' + items[i]; '</th>'
	}

	//曜日
	for(var i = startDay; i < (DAY_OF_MONTH+startDay); i++){
		html += '<th>'+ week[i%7]; +'</th>'
	}
	html += '</tr>'

	html += '<tr>'
	//日付
	for(var i = 1; i <= (DAY_OF_MONTH); i++){
		html += '<th>'+ i +'</th>'

	}
			html += '</tr>'//ここまでヘッダー部分


	html += '<tr>'
	for(var bill of billList){
		var billweek= [
			bill.billSun,
			bill.billMon,
			bill.billTue,
			bill.billWed,
			bill.billThu,
			bill.billFri,
			bill.billSat,
		]

		//ビルの情報の列
		html += '<td rowspan ='+ bill.billPeople +'>'+ bill.billName +'</td>'
		html += '<td rowspan ='+ bill.billPeople +'>'+ bill.billPeople +'</td>'

			//ビルの人数分繰り返す
			for(var j = 1; j <= bill.billPeople; j++){
				//td追加（日毎）
				for(var k = 1; k <= DAY_OF_MONTH; k++){
					//曜日によってデータを格納できるか変更する
					if(billweek[(k+startDay-1)%7] ==0){
						html += '<td style="background-color:#EDF7FF;"></td>'
						continue;
					}

					//kの時の日付を取得、yyyy-mm-dd文字型に変換
					var selectDate = new Date(startDate.getFullYear(),startDate.getMonth(),k);
					var yy =selectDate.getFullYear();
					var mm =("0"+(selectDate.getMonth()+1)).slice(-2);
					var dd =("0"+selectDate.getDate()).slice(-2);

					var selectDateStr = yy+"-"+ mm +"-"+ dd;

					for(var plan of planList){
					if(selectDateStr == plan.planDate
							&& j == plan.staffNumber
							&& bill.billId == plan.billId){
						if(plan.staffId == 1){
         					console.log("nullです");
        	 				html +=  '<td style="background-color:red;">勤務者が居ません</td>'

						}else{

					html += '<td ><a href="/staff/sdetail/'+ plan.staffId + ' ">'
							+ plan.staffName +'</a></td>'
						}


					}//日付、人数、ビルIDのif文終わり
				}
			}	html += '</tr><tr>'
		}
	}
				return html

	}//function createCalendar終了

	function moveCalendar(e) {
	    document.getElementById('calendar').innerHTML = ''

	    if (e.target.id === 'prev') {
	        month--

	        if (month < 1) {
	            year--
	            month = 12
	        }
	    }

	    if (e.target.id === 'next') {
	        month++

	        if (month > 12) {
	            year++
	            month = 1
	        }
	    }

	    showCalendar(year, month)
	}

	document.getElementById('prev').addEventListener('click', moveCalendar)
	document.getElementById('next').addEventListener('click', moveCalendar)

	showCalendar(year, month);
/*]]>*/
</script>

	</div>
</body>
</html>